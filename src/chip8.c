#include "chip8.h"

#include <assert.h>
#include <memory.h>

const char chip8_default_char_set[] = {
    0xf0, 0x90, 0x90, 0x90, 0xf0, 0x20, 0x60, 0x20, 0x20, 0x70, 0xf0, 0x10,
    0xf0, 0x80, 0xf0, 0xf0, 0x10, 0xf0, 0x10, 0xf0, 0x90, 0x90, 0xf0, 0x10,
    0x10, 0xf0, 0x80, 0xf0, 0x10, 0xf0, 0xf0, 0x80, 0xf0, 0x90, 0xf0, 0xf0,
    0x10, 0x20, 0x40, 0x40, 0xf0, 0x90, 0xf0, 0x90, 0xf0, 0xf0, 0x90, 0xf0,
    0x10, 0xf0, 0xf0, 0x90, 0xf0, 0x90, 0x90, 0xe0, 0x90, 0xe0, 0x90, 0xe0,
    0xf0, 0x80, 0x80, 0x80, 0xf0, 0xe0, 0x90, 0x90, 0x90, 0xe0, 0xf0, 0x80,
    0xf0, 0x80, 0xf0, 0xf0, 0x80, 0xf0, 0x80, 0x80};

void chip8_init(chip8 *chip8_) {
  // since this is initialized to a particular instance of chip8 I passed
  // sizeof(*chip8_) to be for that specific instance

  memset(chip8_, 0, sizeof(*chip8_));
  memcpy(&chip8_->memory.memory, chip8_default_char_set,
         sizeof(chip8_default_char_set));
}

static void chip8_exec_extended(chip8 *chip8, unsigned short opcode) {
  unsigned short nnn = opcode & 0x0fff;

  switch (opcode & 0xf000) {
  case 0x1000:
    chip8->registers.PC = nnn;
    break;
  }
}

void chip8_exec(chip8 *chip8, unsigned short opcode) {
  switch (opcode) {
  // clear screen
  case 0x00E0:
    chip8_screen_clear(&chip8->screen);
    break;

  // return from subroutine
  case 0x00EE:
    chip8->registers.PC = chip8_stack_pop(chip8);
    break;

  default:
    chip8_exec_extended(chip8, opcode);
  }
}

void chip8_load(chip8 *chip8_, const char *buf, size_t size) {
  assert(size + CHIP8_PROGRAM_LOAD_ADDR < CHIP8_MEMORY_SIZE);
  memcpy(&chip8_->memory.memory[CHIP8_PROGRAM_LOAD_ADDR], buf, size);
  chip8_->registers.PC = CHIP8_PROGRAM_LOAD_ADDR;
}
